---
title: "Nut Net 2018 Workshop"
output: html_notebook
---

# Species-specific directional change

Given that we see that multiple nutrient addition produces greater change than just single nutrient additions,
do we expect that nutrient identity matters - does the addition of one limiting nutrient produce consistent changes in 
species-specific directional change.

What sites/blocks show consistent directional change?

* There should be more consistent directional change when there is a tradeoff with nutrient enrichment strategy
    * The more spatial heterogeneity in environmental heterogeneity, the more likelihood that different resource use strategies predominate
    * Temporal change and its relationship?

* What species are associated with directional change?

Steps to analyses:

```{r, message = FALSE, echo = FALSE, warning = FALSE}
################################################################################
### Data preprocessing

# Loading necessary packages
library(codyn) # Temporal analysis
library(ggplot2) # Figure plotting
library(tidyverse) # Data manipulation
library(lubridate)
library(data.table)
library(vegetarian) # Exponentiated diversity indices (Hill Numbers)
library(lme4) # Linear mixed effects models
library(vegan)
library(data.table)

################################################################################
# Loading in dataset (April 2018 Data)
cov.long <- fread('C:/Users/ebatz/Dropbox/NutNet Data/full-cover-09-April-2018.csv',
                  na.strings = c('NA','NULL'))

# Subsetting to just California sites
# site.subset <- c("mcla.us", "hopl.us", "sier.us", "elliot.us", "sedg.us",
#                  "cdcr.us", "konz.us", "cbgb.us", "trel.us", "cdpt.us")

# cov.long <- cov.long[cov.long$site_code %in% site.subset,]

# Choose identifying variables
ids <- c('site_code','year','year_trt', 'block','plot','trt')

# Remove non-live percent cover esimates
cov.long[,max_cover:=as.numeric(max_cover)] 
cov.long <- cov.long[live==1]

# Cast long into wide
plot.sp.mat <- dcast(cov.long,site_code+year+block+plot+trt+year_trt ~ Taxon,value.var='max_cover', 
                     fun.aggregate = sum,drop=T,fill=0)


head(plot.sp.mat)[, 1:10]
```

# Subsetting by sites that have > 10 years of data and removing all species with counts == 0

```{r}
# Selecting sites with years greater than or equal to 10
lt_sites = plot.sp.mat %>% 
  group_by(site_code) %>% 
  summarise(uniqueyears = length(unique(year))) %>%
  filter(uniqueyears >= 10) %>%
  select(site_code)

# Filtering based on those site codes
dat = plot.sp.mat %>% filter(site_code %in% c(lt_sites$site_code))

# Selecting columns with all values greater than 0
dat = bind_cols(dat[,1:6], dat[,7:ncol(dat)][,colSums(dat[,7:ncol(dat)]) > 0])
```

# Running permutational ANOVA

```{r}
# Filtering to a single site:
# plot.sp.mat = plot.sp.mat %>% filter(site_code == "cdcr.us")
com.attr <- plot.sp.mat[,1:6]
com.mat <- plot.sp.mat[,7:ncol(plot.sp.mat)]

# Permutational ANOVA
mod_anov <- adonis(com.mat ~ trt:year_trt, 
                   strata = com.attr$site + com.attr$site : com.attr$block, 
                    permutations = 10,
                   data = com.attr)

# Principal comoponents of 
spec_pca = rda(mod_anov$coefficients)
biplot(spec_pca,
       display = "species", 
         type = c("text", "points"))

dim(mod_anov$coefficients)
mod_anov$coefficients[1:5, 1:5]
```

